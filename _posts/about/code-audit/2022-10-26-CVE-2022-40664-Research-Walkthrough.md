---
layout: about
category: about
Researchname:  CVE-2022-40664 Shiro Bypass研究历程
toc: true
author: Bin4xin
permalink: /about/CVE-2022-40664-Research-Walkthrough/
desc: 「代码审计」
---

> Apache Shiro before 1.10.0, Authentication Bypass Vulnerability in Shiro when forwarding or including via RequestDispatcher.[^6]

{% include extensions/dual-player.html id_y='mQrGYHKD8pk' id_b='BV1YW4y1E7vx' %}

## walkthrough[^1]

```http
GET /admin/auth_pass HTTP/1.1
```

```http
GET /admin/auth HTTP/1.1
```

```http
GET /admin/auth HTTP/1.1
Token: 4ra1n
```

## exchange redirect from forward ?[^3]

```java
    @RequestMapping("/admin/{value}")
    public String CVE_2022_40664_bypass(@PathVariable String value, HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        System.out.println("=========== /admin" +((HttpServletRequest)request).getRequestURI()+ "/ ===========");
        //        request.getRequestDispatcher("/admin/auth").forward(request, response);
        //        return "forward:"+((HttpServletRequest)request).getRequestURI();
        response.sendRedirect("/admin/auth");
        return ("Redirect:/admin/auth");
    }
```

forward[^4] 

```java
request.getRequestDispatcher("/admin/auth").forward(request, response);
```

## shiro 1.10.0

Define Bean[^2]

[SecurityManager](https://github.com/Bin4xin/bigger-than-bigger/blob/master/CoVV/ApacheShiro/CVE-2022-40664/src/main/java/com/example/shirodemo/ShiroConfig.java#L21)[^5]{:target="_blank"}

```java
@Bean
public MyShiroFilterFactoryBean filterRegBean(SecurityManager securityManager) throws Exception{
        // CVE-2022-40664
        // fixed conf
        ShiroFilterConfiguration conf=new ShiroFilterConfiguration();
        conf.setFilterOncePerRequest(false);

        ShiroFilterFactoryBean shiroFilterFactoryBean=new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        shiroFilterFactoryBean.setShiroFilterConfiguration(conf);
        AbstractShiroFilter filter=shiroFilterFactoryBean.getObject();

        MyShiroFilterFactoryBean reg=new MyShiroFilterFactoryBean();
        reg.setFilter(filter);
        reg.addUrlPattern("/*");
        reg.setName("shiroFilter");
        reg.setSecurityManager(securityManager);
        reg.setDispatcherTypes(EnumSet.allOf(DispatcherType.class));
        //fixed conf end.
        return reg;
        }
```

Do not work.

## reference

[^1]: [Lay0us1/CVE-2022-32532](https://github.com/Lay0us1/CVE-2022-32532){:target="_blank"}
[^2]: [defining a bean named 'shiroFilterFactoryBean'](https://blog.csdn.net/hanzl1/article/details/104228376){:target="_blank"}
[^3]: [CVE-2022-40664](https://juejin.cn/post/7154702383720136718#heading-0){:target="_blank"}
[^4]: [Shiro 1.7和1.10对于forward请求的处理](https://blog.csdn.net/xyjy11/article/details/127324055){:target="_blank"}
[^5]: [SpringBoot整合shiro-spring-boot-web-starter](https://blog.csdn.net/liu320yj/article/details/109090797){:target="_blank"}
[^6]: [[ANNOUNCE][CVE-2022-32532] Apache Shiro 1.9.1 released](https://lists.apache.org/thread/y8260dw8vbm99oq7zv6y3mzn5ovk90xh){:target="_blank"}